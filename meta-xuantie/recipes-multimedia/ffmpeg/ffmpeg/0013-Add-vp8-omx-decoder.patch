From db9a9d031fa7fe241407f98090a98117444a0a41 Mon Sep 17 00:00:00 2001
From: huxin <wb-hx963136@alibaba-inc.com>
Date: Wed, 3 Apr 2024 16:21:25 +0800
Subject: [PATCH] Add vp8 omx decoder

---
 configure               | 1 +
 libavcodec/Makefile     | 1 +
 libavcodec/allcodecs.c  | 1 +
 libavcodec/omxdecoder.c | 7 +++++++
 4 files changed, 10 insertions(+)

diff --git a/configure b/configure
index 81d4807..6f0b635 100755
--- a/configure
+++ b/configure
@@ -3259,6 +3259,7 @@ vp9_v4l2m2m_decoder_deps="v4l2_m2m vp9_v4l2_m2m"
 wmv3_crystalhd_decoder_select="crystalhd"
 av1_qsv_decoder_select="qsvdec"
 vc1_omx_decoder_deps="omx"
+vp8_omx_decoder_deps="omx"
 
 # parsers
 aac_parser_select="adts_header mpeg4audio"
diff --git a/libavcodec/Makefile b/libavcodec/Makefile
index d6fb8d4..b402175 100644
--- a/libavcodec/Makefile
+++ b/libavcodec/Makefile
@@ -755,6 +755,7 @@ OBJS-$(CONFIG_VP8_RKMPP_DECODER)       += rkmppdec.o
 OBJS-$(CONFIG_VP8_VAAPI_ENCODER)       += vaapi_encode_vp8.o
 OBJS-$(CONFIG_VP8_V4L2M2M_DECODER)     += v4l2_m2m_dec.o
 OBJS-$(CONFIG_VP8_V4L2M2M_ENCODER)     += v4l2_m2m_enc.o
+OBJS-$(CONFIG_VP8_OMX_DECODER)         += omxdecoder.o
 OBJS-$(CONFIG_VP9_DECODER)             += vp9.o vp9data.o vp9dsp.o vp9lpf.o vp9recon.o \
                                           vp9block.o vp9prob.o vp9mvs.o vp56rac.o \
                                           vp9dsp_8bpp.o vp9dsp_10bpp.o vp9dsp_12bpp.o
diff --git a/libavcodec/allcodecs.c b/libavcodec/allcodecs.c
index 2bb123c..b6197cf 100644
--- a/libavcodec/allcodecs.c
+++ b/libavcodec/allcodecs.c
@@ -47,6 +47,7 @@ extern const FFCodec ff_mpeg4_omx_encoder;
 extern const FFCodec ff_mpeg4_omx_decoder;
 extern const FFCodec ff_h263_omx_decoder;
 extern const FFCodec ff_vc1_omx_decoder;
+extern const FFCodec ff_vp8_omx_decoder;
 
 extern const FFCodec ff_a64multi_encoder;
 extern const FFCodec ff_a64multi5_encoder;
diff --git a/libavcodec/omxdecoder.c b/libavcodec/omxdecoder.c
index 9e309a1..e4eefdb 100644
--- a/libavcodec/omxdecoder.c
+++ b/libavcodec/omxdecoder.c
@@ -97,6 +97,9 @@ typedef enum __DecoderStatus {
     ILLEGAL_STATE
 } DecoderStatus;
 
+typedef enum OMX_VIDEO_CODINGEXTTYPE {
+    OMX_VIDEO_CodingVP8 = OMX_VIDEO_CodingKhronosExtensions + 1
+} OMX_VIDEO_CODINGEXTTYPE;
 
 #define to_omx_ticks(x) (x)
 #define from_omx_ticks(x) (x)
@@ -1517,6 +1520,9 @@ static av_cold int omx_component_init_decoder(AVCodecContext *avctx, const char
     case AV_CODEC_ID_H263:
         formatIn.eCompressionFormat = OMX_VIDEO_CodingH263;
         break;
+    case AV_CODEC_ID_VP8:
+        formatIn.eCompressionFormat = OMX_VIDEO_CodingVP8;
+        break;
     case AV_CODEC_ID_VC1:
         formatIn.eCompressionFormat = OMX_VIDEO_CodingWMV;
         break;
@@ -2148,3 +2154,4 @@ DECLARE_OMX_VDEC(mpeg4, "MPEG-4 part 2", AV_CODEC_ID_MPEG4, NULL)
 DECLARE_OMX_VDEC(vp9, "VP9", AV_CODEC_ID_VP9, NULL)
 DECLARE_OMX_VDEC(h263, "H263", AV_CODEC_ID_H263, NULL)
 DECLARE_OMX_VDEC(vc1, "VC1", AV_CODEC_ID_VC1, NULL)
+DECLARE_OMX_VDEC(vp8, "VP8", AV_CODEC_ID_VP8, NULL)
-- 
2.17.1

