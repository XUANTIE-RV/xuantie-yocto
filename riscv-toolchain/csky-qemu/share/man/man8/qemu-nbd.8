.\" Automatically generated by Pod::Man 2.28 (Pod::Simple 3.29)
.\"
.\" Standard preamble:
.\" ========================================================================
.de Sp \" Vertical space (when we can't use .PP)
.if t .sp .5v
.if n .sp
..
.de Vb \" Begin verbatim text
.ft CW
.nf
.ne \\$1
..
.de Ve \" End verbatim text
.ft R
.fi
..
.\" Set up some character translations and predefined strings.  \*(-- will
.\" give an unbreakable dash, \*(PI will give pi, \*(L" will give a left
.\" double quote, and \*(R" will give a right double quote.  \*(C+ will
.\" give a nicer C++.  Capital omega is used to do unbreakable dashes and
.\" therefore won't be available.  \*(C` and \*(C' expand to `' in nroff,
.\" nothing in troff, for use with C<>.
.tr \(*W-
.ds C+ C\v'-.1v'\h'-1p'\s-2+\h'-1p'+\s0\v'.1v'\h'-1p'
.ie n \{\
.    ds -- \(*W-
.    ds PI pi
.    if (\n(.H=4u)&(1m=24u) .ds -- \(*W\h'-12u'\(*W\h'-12u'-\" diablo 10 pitch
.    if (\n(.H=4u)&(1m=20u) .ds -- \(*W\h'-12u'\(*W\h'-8u'-\"  diablo 12 pitch
.    ds L" ""
.    ds R" ""
.    ds C` ""
.    ds C' ""
'br\}
.el\{\
.    ds -- \|\(em\|
.    ds PI \(*p
.    ds L" ``
.    ds R" ''
.    ds C`
.    ds C'
'br\}
.\"
.\" Escape single quotes in literal strings from groff's Unicode transform.
.ie \n(.g .ds Aq \(aq
.el       .ds Aq '
.\"
.\" If the F register is turned on, we'll generate index entries on stderr for
.\" titles (.TH), headers (.SH), subsections (.SS), items (.Ip), and index
.\" entries marked with X<> in POD.  Of course, you'll have to process the
.\" output yourself in some meaningful fashion.
.\"
.\" Avoid warning from groff about undefined register 'F'.
.de IX
..
.nr rF 0
.if \n(.g .if rF .nr rF 1
.if (\n(rF:(\n(.g==0)) \{
.    if \nF \{
.        de IX
.        tm Index:\\$1\t\\n%\t"\\$2"
..
.        if !\nF==2 \{
.            nr % 0
.            nr F 2
.        \}
.    \}
.\}
.rr rF
.\" ========================================================================
.\"
.IX Title "QEMU-NBD.8 8"
.TH QEMU-NBD.8 8 "2020-01-07" " " " "
.\" For nroff, turn off justification.  Always turn off hyphenation; it makes
.\" way too many mistakes in technical documents.
.if n .ad l
.nh
.SH "NAME"
qemu\-nbd \- QEMU Disk Network Block Device Server
.SH "SYNOPSIS"
.IX Header "SYNOPSIS"
\&\fBqemu-nbd\fR [\s-1OPTION\s0]... \fIfilename\fR
.PP
\&\fBqemu-nbd\fR \fB\-L\fR [\s-1OPTION\s0]...
.PP
\&\fBqemu-nbd\fR \fB\-d\fR \fIdev\fR
.SH "DESCRIPTION"
.IX Header "DESCRIPTION"
Export a \s-1QEMU\s0 disk image using the \s-1NBD\s0 protocol.
.PP
Other uses:
.IP "\(bu" 4
Bind a /dev/nbdX block device to a \s-1QEMU\s0 server (on Linux).
.IP "\(bu" 4
As a client to query exports of a remote \s-1NBD\s0 server.
.SH "OPTIONS"
.IX Header "OPTIONS"
\&\fIfilename\fR is a disk image filename, or a set of block
driver options if \fB\-\-image\-opts\fR is specified.
.PP
\&\fIdev\fR is an \s-1NBD\s0 device.
.IP "\fB\-\-object type,id=\fR\fIid\fR\fB,...props...\fR" 4
.IX Item "--object type,id=id,...props..."
Define a new instance of the \fItype\fR object class identified by \fIid\fR.
See the \f(CWqemu(1)\fR manual page for full details of the properties
supported. The common object types that it makes sense to define are the
\&\f(CW\*(C`secret\*(C'\fR object, which is used to supply passwords and/or encryption
keys, and the \f(CW\*(C`tls\-creds\*(C'\fR object, which is used to supply \s-1TLS\s0
credentials for the qemu-nbd server or client.
.IP "\fB\-p, \-\-port=\fR\fIport\fR" 4
.IX Item "-p, --port=port"
The \s-1TCP\s0 port to listen on as a server, or connect to as a client
(default \fB10809\fR).
.IP "\fB\-o, \-\-offset=\fR\fIoffset\fR" 4
.IX Item "-o, --offset=offset"
The offset into the image.
.IP "\fB\-b, \-\-bind=\fR\fIiface\fR" 4
.IX Item "-b, --bind=iface"
The interface to bind to as a server, or connect to as a client
(default \fB0.0.0.0\fR).
.IP "\fB\-k, \-\-socket=\fR\fIpath\fR" 4
.IX Item "-k, --socket=path"
Use a unix socket with path \fIpath\fR.
.IP "\fB\-\-image\-opts\fR" 4
.IX Item "--image-opts"
Treat \fIfilename\fR as a set of image options, instead of a plain
filename. If this flag is specified, the \fI\-f\fR flag should
not be used, instead the '\f(CW\*(C`format=\*(C'\fR' option should be set.
.IP "\fB\-f, \-\-format=\fR\fIfmt\fR" 4
.IX Item "-f, --format=fmt"
Force the use of the block driver for format \fIfmt\fR instead of
auto-detecting.
.IP "\fB\-r, \-\-read\-only\fR" 4
.IX Item "-r, --read-only"
Export the disk as read-only.
.IP "\fB\-P, \-\-partition=\fR\fInum\fR" 4
.IX Item "-P, --partition=num"
Deprecated: Only expose \s-1MBR\s0 partition \fInum\fR.  Understands physical
partitions 1\-4 and logical partition 5. New code should instead use
\&\fB\-\-image\-opts\fR with the raw driver wrapping a subset of the
original image.
.IP "\fB\-B, \-\-bitmap=\fR\fIname\fR" 4
.IX Item "-B, --bitmap=name"
If \fIfilename\fR has a qcow2 persistent bitmap \fIname\fR, expose
that bitmap via the "qemu:dirty\-bitmap:\fIname\fR" context
accessible through \s-1NBD_OPT_SET_META_CONTEXT.\s0
.IP "\fB\-s, \-\-snapshot\fR" 4
.IX Item "-s, --snapshot"
Use \fIfilename\fR as an external snapshot, create a temporary
file with backing_file=\fIfilename\fR, redirect the write to
the temporary one.
.IP "\fB\-l, \-\-load\-snapshot=\fR\fIsnapshot_param\fR" 4
.IX Item "-l, --load-snapshot=snapshot_param"
Load an internal snapshot inside \fIfilename\fR and export it
as an read-only device, \fIsnapshot_param\fR format is
\&'snapshot.id=[\s-1ID\s0],snapshot.name=[\s-1NAME\s0]' or '[\s-1ID_OR_NAME\s0]'
.IP "\fB\-n, \-\-nocache\fR" 4
.IX Item "-n, --nocache"
.PD 0
.IP "\fB\-\-cache=\fR\fIcache\fR" 4
.IX Item "--cache=cache"
.PD
The cache mode to be used with the file.  See the documentation of
the emulator's \f(CW\*(C`\-drive cache=...\*(C'\fR option for allowed values.
.IP "\fB\-\-aio=\fR\fIaio\fR" 4
.IX Item "--aio=aio"
Set the asynchronous I/O mode between \fBthreads\fR (the default)
and \fBnative\fR (Linux only).
.IP "\fB\-\-discard=\fR\fIdiscard\fR" 4
.IX Item "--discard=discard"
Control whether \fIdiscard\fR (also known as \fItrim\fR or \fIunmap\fR)
requests are ignored or passed to the filesystem.  \fIdiscard\fR is one of
\&\fBignore\fR (or \fBoff\fR), \fBunmap\fR (or \fBon\fR).  The default is
\&\fBignore\fR.
.IP "\fB\-\-detect\-zeroes=\fR\fIdetect-zeroes\fR" 4
.IX Item "--detect-zeroes=detect-zeroes"
Control the automatic conversion of plain zero writes by the \s-1OS\s0 to
driver-specific optimized zero write commands.  \fIdetect-zeroes\fR is one of
\&\fBoff\fR, \fBon\fR or \fBunmap\fR.  \fBunmap\fR
converts a zero write to an unmap operation and can only be used if
\&\fIdiscard\fR is set to \fBunmap\fR.  The default is \fBoff\fR.
.IP "\fB\-c, \-\-connect=\fR\fIdev\fR" 4
.IX Item "-c, --connect=dev"
Connect \fIfilename\fR to \s-1NBD\s0 device \fIdev\fR (Linux only).
.IP "\fB\-d, \-\-disconnect\fR" 4
.IX Item "-d, --disconnect"
Disconnect the device \fIdev\fR (Linux only).
.IP "\fB\-e, \-\-shared=\fR\fInum\fR" 4
.IX Item "-e, --shared=num"
Allow up to \fInum\fR clients to share the device (default
\&\fB1\fR). Safe for readers, but for now, consistency is not
guaranteed between multiple writers.
.IP "\fB\-t, \-\-persistent\fR" 4
.IX Item "-t, --persistent"
Don't exit on the last connection.
.IP "\fB\-x, \-\-export\-name=\fR\fIname\fR" 4
.IX Item "-x, --export-name=name"
Set the \s-1NBD\s0 volume export name (default of a zero-length string).
.IP "\fB\-D, \-\-description=\fR\fIdescription\fR" 4
.IX Item "-D, --description=description"
Set the \s-1NBD\s0 volume export description, as a human-readable
string.
.IP "\fB\-L, \-\-list\fR" 4
.IX Item "-L, --list"
Connect as a client and list all details about the exports exposed by
a remote \s-1NBD\s0 server.  This enables list mode, and is incompatible
with options that change behavior related to a specific export (such as
\&\fB\-\-export\-name\fR, \fB\-\-offset\fR, ...).
.IP "\fB\-\-tls\-creds=ID\fR" 4
.IX Item "--tls-creds=ID"
Enable mandatory \s-1TLS\s0 encryption for the server by setting the \s-1ID\s0
of the \s-1TLS\s0 credentials object previously created with the \-\-object
option; or provide the credentials needed for connecting as a client
in list mode.
.IP "\fB\-\-fork\fR" 4
.IX Item "--fork"
Fork off the server process and exit the parent once the server is running.
.IP "\fB\-\-pid\-file=PATH\fR" 4
.IX Item "--pid-file=PATH"
Store the server's process \s-1ID\s0 in the given file.
.IP "\fB\-\-tls\-authz=ID\fR" 4
.IX Item "--tls-authz=ID"
Specify the \s-1ID\s0 of a qauthz object previously created with the
\&\-\-object option. This will be used to authorize connecting users
against their x509 distinguished name.
.IP "\fB\-v, \-\-verbose\fR" 4
.IX Item "-v, --verbose"
Display extra debugging information.
.IP "\fB\-h, \-\-help\fR" 4
.IX Item "-h, --help"
Display this help and exit.
.IP "\fB\-V, \-\-version\fR" 4
.IX Item "-V, --version"
Display version information and exit.
.IP "\fB\-T, \-\-trace [[enable=]\fR\fIpattern\fR\fB][,events=\fR\fIfile\fR\fB][,file=\fR\fIfile\fR\fB]\fR" 4
.IX Item "-T, --trace [[enable=]pattern][,events=file][,file=file]"
Specify tracing options.
.RS 4
.IP "\fB[enable=]\fR\fIpattern\fR" 4
.IX Item "[enable=]pattern"
Immediately enable events matching \fIpattern\fR
(either event name or a globbing pattern).  This option is only
available if \s-1QEMU\s0 has been compiled with the \fIsimple\fR, \fIlog\fR
or \fIftrace\fR tracing backend.  To specify multiple events or patterns,
specify the \fB\-trace\fR option multiple times.
.Sp
Use \f(CW\*(C`\-trace help\*(C'\fR to print a list of names of trace points.
.IP "\fBevents=\fR\fIfile\fR" 4
.IX Item "events=file"
Immediately enable events listed in \fIfile\fR.
The file must contain one event name (as listed in the \fItrace-events-all\fR
file) per line; globbing patterns are accepted too.  This option is only
available if \s-1QEMU\s0 has been compiled with the \fIsimple\fR, \fIlog\fR or
\&\fIftrace\fR tracing backend.
.IP "\fBfile=\fR\fIfile\fR" 4
.IX Item "file=file"
Log output traces to \fIfile\fR.
This option is only available if \s-1QEMU\s0 has been compiled with
the \fIsimple\fR tracing backend.
.RE
.RS 4
.RE
.SH "EXAMPLES"
.IX Header "EXAMPLES"
Start a server listening on port 10809 that exposes only the
guest-visible contents of a qcow2 file, with no \s-1TLS\s0 encryption, and
with the default export name (an empty string). The command is
one-shot, and will block until the first successful client
disconnects:
.PP
.Vb 1
\&        qemu\-nbd \-f qcow2 file.qcow2
.Ve
.PP
Start a long-running server listening with encryption on port 10810,
and whitelist clients with a specific X.509 certificate to connect to
a 1 megabyte subset of a raw file, using the export name 'subset':
.PP
.Vb 7
\&        qemu\-nbd \e
\&          \-\-object tls\-creds\-x509,id=tls0,endpoint=server,dir=/path/to/qemutls \e
\&          \-\-object \*(Aqauthz\-simple,id=auth0,identity=CN=laptop.example.com,,\e
\&                    O=Example Org,,L=London,,ST=London,,C=GB\*(Aq \e
\&          \-\-tls\-creds tls0 \-\-tls\-authz auth0 \e
\&          \-t \-x subset \-p 10810 \e
\&          \-\-image\-opts driver=raw,offset=1M,size=1M,file.driver=file,file.filename=file.raw
.Ve
.PP
Serve a read-only copy of just the first \s-1MBR\s0 partition of a guest
image over a Unix socket with as many as 5 simultaneous readers, with
a persistent process forked as a daemon:
.PP
.Vb 2
\&        qemu\-nbd \-\-fork \-\-persistent \-\-shared=5 \-\-socket=/path/to/sock \e
\&          \-\-partition=1 \-\-read\-only \-\-format=qcow2 file.qcow2
.Ve
.PP
Expose the guest-visible contents of a qcow2 file via a block device
/dev/nbd0 (and possibly creating /dev/nbd0p1 and friends for
partitions found within), then disconnect the device when done.
Access to bind qemu-nbd to an /dev/nbd device generally requires root
privileges, and may also require the execution of \f(CW\*(C`modprobe nbd\*(C'\fR
to enable the kernel \s-1NBD\s0 client module.  \fI\s-1CAUTION\s0\fR: Do not use
this method to mount filesystems from an untrusted guest image \- a
malicious guest may have prepared the image to attempt to trigger
kernel bugs in partition probing or file system mounting.
.PP
.Vb 2
\&        qemu\-nbd \-c /dev/nbd0 \-f qcow2 file.qcow2
\&        qemu\-nbd \-d /dev/nbd0
.Ve
.PP
Query a remote server to see details about what export(s) it is
serving on port 10809, and authenticating via \s-1PSK:\s0
.PP
.Vb 3
\&        qemu\-nbd \e
\&          \-\-object tls\-creds\-psk,id=tls0,dir=/tmp/keys,username=eblake,endpoint=client \e
\&          \-\-tls\-creds tls0 \-L \-b remote.example.com
.Ve
.SH "SEE ALSO"
.IX Header "SEE ALSO"
\&\fIqemu\fR\|(1), \fIqemu\-img\fR\|(1)
.SH "AUTHOR"
.IX Header "AUTHOR"
Copyright (C) 2006 Anthony Liguori <anthony@codemonkey.ws>.
This is free software; see the source for copying conditions.  There is \s-1NO\s0
warranty; not even for \s-1MERCHANTABILITY\s0 or \s-1FITNESS FOR A PARTICULAR PURPOSE.\s0
